"use strict";var $;class AIOVGVideoElement extends HTMLElement{constructor(){super(),this.player=null,this.playButtonEl=null,this.settings={},this._playerId="",this._hasVideoStarted=!1,this._ajaxUrl=aiovg_player.ajax_url,this._ajaxNonce=aiovg_player.ajax_nonce}connectedCallback(){if(this._playerId=this.dataset.id||"",this.settings=this.dataset.params?JSON.parse(this.dataset.params):{},this.settings.hasOwnProperty("player")||(this.settings.player={}),this.settings.player.html5={vhs:{overrideNative:!videojs.browser.IS_ANY_SAFARI}},this.settings.cookie_consent){let t=this.querySelector(".aiovg-privacy-consent-button");null!==t&&t.addEventListener("click",()=>this._onCookieConsent())}else this._initPlayer()}disconnectedCallback(){}_onCookieConsent(){this.settings.player.autoplay=!0,this._setCookie();let t=document.querySelectorAll(".aiovg-player-element");for(let e=0;e<t.length;e++)t[e].removeCookieConsent();window.postMessage({message:"aiovg-cookie-consent"},window.location.origin)}_initPlayer(){this.player=videojs(this.querySelector("video-js"),this.settings.player),this.player.ready(()=>this._onReady()),this.player.one("loadedmetadata",()=>this._onMetadataLoaded()),this.player.on("play",()=>this._onPlay()),this.player.on("playing",()=>this._onPlaying()),this.player.on("ended",()=>this._onEnded()),this._initOffset(),this._initChapters(),this._initQualitySelector(),this._initOverlays(),this._initHotKeys(),this._initContextMenu();let t={id:this._playerId,player_id:this._playerId,config:this.settings,settings:this.settings,player:this.player};this._dispatchEvent("player.init",t)}_onReady(){this.classList.remove("vjs-waiting"),this.playButtonEl=this.querySelector(".vjs-big-play-button"),null!==this.playButtonEl&&this.playButtonEl.addEventListener("click",()=>this._onPlayClicked())}_onMetadataLoaded(){let t=this.querySelector(".vjs-quality-selector");if(null!==t){let e=t.querySelectorAll(".vjs-menu-item");for(let s=0;s<e.length;s++){let i=e[s],n=i.querySelector(".vjs-menu-item-text"),a=n.innerHTML.replace(/\D/g,"");a>=2160?i.innerHTML+='<span class="vjs-quality-menu-item-sub-label">4K</span>':a>=720&&(i.innerHTML+='<span class="vjs-quality-menu-item-sub-label">HD</span>')}}if(this.settings.hasOwnProperty("tracks"))for(let o=0,l=this.settings.tracks.length;o<l;o++){let r=this.settings.tracks[o],h="";if(0==o&&1==this.settings.cc_load_policy&&(h="showing"),/srt/.test(r.src.toLowerCase()))this._addSrtTextTrack(r,h);else{let d={kind:"captions",src:r.src,label:r.label,srclang:r.srclang};h&&(d.mode=h),this.player.addRemoteTextTrack(d,!0)}}this.settings.hasOwnProperty("chapters")&&this._addMarkers()}_onPlayClicked(){this._hasVideoStarted||this.classList.add("vjs-waiting"),this.playButtonEl.removeEventListener("click",()=>this._onPlayClicked())}_onPlay(){this._hasVideoStarted||(this._hasVideoStarted=!0,this.classList.remove("vjs-waiting"),this._updateViewsCount());let t=document.querySelectorAll(".aiovg-player-element");for(let e=0;e<t.length;e++)t[e]!=this&&t[e].pause();window.postMessage({message:"aiovg-video-playing"},window.location.origin)}_onPlaying(){this.player.trigger("controlsshown")}_onEnded(){this.player.trigger("controlshidden")}_initOffset(){let t={};this.settings.hasOwnProperty("start")&&(t.start=this.settings.start),this.settings.hasOwnProperty("end")&&(t.end=this.settings.end),Object.keys(t).length>1&&(t.restart_beginning=!1,this.player.offset(t))}_initChapters(){if(!this.settings.hasOwnProperty("chapters"))return!1;let t=this;try{this.player.getDescendant(["ControlBar","ProgressControl","SeekBar","MouseTimeDisplay","TimeTooltip",]).update=function(e,s,i){let n=t.settings.chapters,a=n.findIndex(({time:e})=>e==t._formatedTimeToSeconds(i));if(a>-1){let o=n[a].label;return videojs.dom.emptyEl(this.el()),videojs.dom.appendContent(this.el(),[t._labelEl(o),t._timeEl(i)]),!1}this.write(i)}}catch(e){}}_initQualitySelector(){this.player.on("qualitySelected",(t,e)=>{let s=e.label.replace(/\D/g,"");this.player.removeClass("vjs-4k"),this.player.removeClass("vjs-hd"),s>=2160?this.player.addClass("vjs-4k"):s>=720&&this.player.addClass("vjs-hd")});let t=this.player.src();(/.m3u8/.test(t)||/.mpd/.test(t))&&-1!=this.settings.player.controlBar.children.indexOf("qualitySelector")&&this.player.qualityMenu()}_initOverlays(){let t=[];if((this.settings.hasOwnProperty("share")||this.settings.hasOwnProperty("embed"))&&t.push({content:'<button type="button" class="vjs-share-embed-button" title="Share"><span class="vjs-icon-share" aria-hidden="true"></span><span class="vjs-control-text" aria-live="polite">Share</span></button>',class:"vjs-share",align:"top-right",start:"controlsshown",end:"controlshidden",showBackground:!1}),this.settings.hasOwnProperty("download")){let e="vjs-download";(this.settings.hasOwnProperty("share")||this.settings.hasOwnProperty("embed"))&&(e+=" vjs-has-share"),t.push({content:'<a href="'+this.settings.download.url+'" class="vjs-download-button" title="Download" target="_blank"><span class="vjs-icon-file-download" aria-hidden="true"></span><span class="vjs-control-text" aria-live="polite">Download</span></a>',class:e,align:"top-right",start:"controlsshown",end:"controlshidden",showBackground:!1})}if(this.settings.hasOwnProperty("logo")){this.settings.logo.margin&&(this.settings.logo.margin=this.settings.logo.margin-5);let s="margin: "+this.settings.logo.margin+"px;",i="bottom-left";switch(this.settings.logo.position){case"topleft":i="top-left";break;case"topright":i="top-right";break;case"bottomright":i="bottom-right"}let n='<a href="'+this.settings.logo.link+'" style="'+s+'"><img src="'+this.settings.logo.image+'" alt="" /><span class="vjs-control-text" aria-live="polite">Logo</span></a>';t.push({content:n,class:"vjs-logo",align:i,start:"controlsshown",end:"controlshidden",showBackground:!1})}if(t.length>0){if(this.player.overlay({content:"",overlays:t}),this.settings.hasOwnProperty("share")||this.settings.hasOwnProperty("embed")){let a={};a.content=this.querySelector(".vjs-share-embed"),a.temporary=!1;let o=videojs.getComponent("ModalDialog"),l=new o(this.player,a);l.addClass("vjs-modal-dialog-share-embed"),this.player.addChild(l);let r=!0;this.querySelector(".vjs-share-embed-button").addEventListener("click",()=>{r=!this.player.paused,l.open()}),l.on("modalclose",()=>{r&&this.player.play()})}this.settings.hasOwnProperty("embed")&&this.querySelector(".vjs-input-embed-code").addEventListener("focus",function(){this.select(),document.execCommand("copy")})}}_initHotKeys(){this.settings.hotkeys&&this.player.hotkeys()}_initContextMenu(){if(!this.settings.hasOwnProperty("contextmenu"))return!1;let t=document.querySelector("#aiovg-contextmenu");null===t&&((t=document.createElement("div")).id="aiovg-contextmenu",t.style.display="none",t.innerHTML='<div class="aiovg-contextmenu-content">'+this.settings.contextmenu.content+"</div>",document.body.appendChild(t),document.addEventListener("click",()=>{t.style.display="none"}));let e="";this.addEventListener("contextmenu",function(s){if(3==s.keyCode||3==s.which){s.preventDefault(),s.stopPropagation();let i=t.offsetWidth,n=t.offsetHeight,a=s.pageX,o=s.pageY,l=document.documentElement,r=(window.pageXOffset||l.scrollLeft)-(l.clientLeft||0),h=(window.pageYOffset||l.scrollTop)-(l.clientTop||0),d=a+i>window.innerWidth+r?a-i:a,c=o+n>window.innerHeight+h?o-n:o;t.style.display="",t.style.left=d+"px",t.style.top=c+"px",clearTimeout(e),e=setTimeout(()=>{t.style.display="none"},1500)}})}_addSrtTextTrack(t,e){let s;(s=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).onreadystatechange=()=>{if(4==s.readyState&&200==s.status&&s.responseText){let i=this._srtToWebVTT(s.responseText);if(i){let n=new Blob([i],{type:"text/vtt"}),a=URL.createObjectURL(n),o={kind:"captions",src:a,label:t.label,srclang:t.srclang};e&&(o.mode=e),this.player.addRemoteTextTrack(o,!0)}}},s.open("GET",t.src,!0),s.send()}_srtToWebVTT(t){let e=t.replace(/\r+/g,""),s=(e=e.replace(/^\s+|\s+$/g,"")).split("\n\n"),i="";if(s.length>0){i+="WEBVTT\n\n";for(let n=0;n<s.length;n++)i+=this._convertSrtCue(s[n])}return i}_convertSrtCue(t){let e="",s=t.split(/\n/);for(;s.length>3;){for(let i=3;i<s.length;i++)s[2]+="\n"+s[i];s.splice(3,s.length-3)}let n=0;if(!s[0].match(/\d+:\d+:\d+/)&&s[1].match(/\d+:\d+:\d+/)&&(e+=s[0].match(/\w+/)+"\n",n+=1),!s[n].match(/\d+:\d+:\d+/))return"";{let a=s[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);if(!a)return"";e+=a[1]+":"+a[2]+":"+a[3]+"."+a[4]+" --> "+a[5]+":"+a[6]+":"+a[7]+"."+a[8]+"\n",n+=1}return s[n]&&(e+=s[n]+"\n\n"),e}_addMarkers(){let t=this.player.duration(),e=this.player.el_.querySelector(".vjs-progress-control .vjs-progress-holder");if(null!==e)for(let s=0;s<this.settings.chapters.length;s++){let i=document.createElement("div");i.className="vjs-marker",i.style.left=this.settings.chapters[s].time/t*100+"%",e.appendChild(i)}}_formatedTimeToSeconds(t){let e=t.split(":"),s=+e.pop();return e.reduce((t,e,s,i)=>2===i.length&&1===s?t+3600*+e:t+60*+e,s)}_timeEl(t){return videojs.dom.createEl("span",void 0,void 0,"("+t+")")}_labelEl(t){return videojs.dom.createEl("strong",void 0,void 0,t)}_dispatchEvent(t,e){jQuery(this).trigger(t,e)}_fetch(t){jQuery.post(this._ajaxUrl,t)}async _setCookie(){let t={action:"aiovg_set_cookie",security:this._ajaxNonce};this._fetch(t)}async _updateViewsCount(){if("aiovg_videos"!=this.settings.post_type)return!1;let t={action:"aiovg_update_views_count",post_id:this.settings.post_id,duration:this.player.duration()||0,security:this._ajaxNonce};this._fetch(t)}removeCookieConsent(){let t=this.querySelector(".aiovg-privacy-wrapper");null!=t&&(t.remove(),this._initPlayer())}pause(){this.player&&this.player.pause()}seekTo(t){this.player&&(this.player.currentTime(t),this._hasVideoStarted||this.player.play())}}($=jQuery)(function(){customElements.define("aiovg-video",AIOVGVideoElement),"undefined"!=typeof videojs&&videojs.hook("beforeerror",function(t,e){if(null==e)return t.error();if(2==e.code||4==e.code){let s=t.src();if(/.m3u8/.test(s)||/.mpd/.test(s))return{code:e.code,message:aiovg_player.i18n.stream_not_found}}return e}),window.addEventListener("message",function(t){if(t.origin!=window.location.origin||!t.data.hasOwnProperty("context")||"iframe"!=t.data.context||!t.data.hasOwnProperty("message"))return!1;if("aiovg-cookie-consent"==t.data.message){let e=document.querySelectorAll(".aiovg-player-element");for(let s=0;s<e.length;s++)e[s].removeCookieConsent()}if("aiovg-video-playing"==t.data.message){let i=document.querySelectorAll(".aiovg-player-element");for(let n=0;n<i.length;n++)i[n].pause()}})});